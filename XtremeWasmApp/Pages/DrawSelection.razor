@page "/DrawSelection"
@using XtremeModels
@inject IJSRuntime JsRuntime
@inject ILocalStorageService _storage
@inject WebApiService ApiService
<AuthorizeView>

    <Authorized>
        <MudText Typo="Typo.h4">Draw Selection</MudText>
        @if (ErrorsList?.Any() == true)
        {
            foreach (var item in ErrorsList)
            {
                <MudText Color="@Color.Error">@item</MudText>
            }
        }

        @if (schedules is null)
        {
            <MudText Typo="Typo.h5">Loading....</MudText>
        }
        else
        {
            if (schedules.Any())
            {
                <MudSimpleTable  Hover="true" FixedHeader="true" Style="overflow-x: auto;">
                    <thead>
                        <tr>
                            <th></th>
                            <th style="text-align:center;font-size:large;"><b>Draw</b></th>
                            <th style="text-align:center;font-size:large;"><b>Date</b></th>
                            <th style="text-align:center;font-size:large;"><b>City</b></th>
                            @if (windowWidth > 500)
                            {
                                <th style="text-align:center;font-size:large;"><b>Category</b></th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int count = 0;
                        }
                        @foreach (var row in schedules)
                        {
                            int currCount = count;
                            <tr @onclick="@(()=>onRowSelection(currCount))">

                                <td style="text-align:center;max-width:30px;"><MudIcon Icon="@(row.Uac?Icons.Material.Filled.Edit:Icons.Material.Filled.EditOff)" Color="@(row.Uac?Color.Success:Color.Error)" Title="Pencil" /></td>

                                <td style="text-align:center;min-width:105px;">@(row.DId+" - "+ row.BId)</td>
                                <td style="text-align:center;max-width:90px;">@row.Date.ToString("dd/MM/yyyy")</td>
                                <td style="text-align:center;font-size:large;min-width:100px;">@row.City</td>
                                @if (windowWidth > 500)
                                {
                                    <td style="text-align:center;font-size:large;">@row.Cat</td>
                                }
                            </tr>
                            count++;
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudText Typo="Typo.h5">No draws</MudText>
            }
        }
    </Authorized>
</AuthorizeView>
@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "onlyactive")]
    public bool onlyactive { get; set; }
    [CascadingParameter]
    public Timer _timer { get; set; }

    public IList<string> ErrorsList;
    IList<Schedule> schedules;

    private IJSObjectReference jsModule;

    public int windowHeight, windowWidth;

    public class WindowDimensions
    {
        public int Width { get; set; }
        public int Height { get; set; }
    }
    protected override async Task OnInitializedAsync()
    {
        IList<Schedule>? schT = null;
        if (onlyactive)
        {
            schT = await ApiService.GetScheduleList(onlyactive,false);

        }
        else
        {
            var drawSel = await ApiService.IsDrawSelected();
            schT = await ApiService.GetAllSch();
            if (schT is null)
            {
                bool GetAll = !drawSel;

                schT = await ApiService.GetScheduleList(GetAll,drawSel);
            }
        }
        if (schT.Count == 1)
        {
            var res = await ApiService.ChangeSchedule(schT[0],_timer);
            if (!res.Item1)
            {
                ErrorsList = new List<string>() { res.Item2, "Either the draw is closed, or there was an error" };
                schedules = schT;
                await InvokeAsync(StateHasChanged).ConfigureAwait(false);
            }
        }
        else
        {
            schedules = schT;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/Dimentions.js");

        }
        if (jsModule is not null)
        {
            var (prevHeight, prevWidth) = (windowHeight, windowWidth);
            var dimension = await jsModule.InvokeAsync<WindowDimensions>("getWindowSize");
            windowHeight = dimension.Height;
            windowWidth = dimension.Width;
            if ((prevHeight, prevWidth) != (windowHeight, windowWidth))
            {
                await InvokeAsync(StateHasChanged).ConfigureAwait(false);
            }
        }
    }
    private async Task onRowSelection(int rowIndex)
    {
        var currSel = schedules[rowIndex];
        if (currSel.blocked)
        {
            ErrorsList = new List<string>() { "This draw is blocked" };
            await InvokeAsync(StateHasChanged).ConfigureAwait(false);
            return;
        }
        var res = await ApiService.ChangeSchedule(currSel,_timer);
        if (!res.Item1)
        {
            ErrorsList = new List<string>() { res.Item2, "Either the draw is closed, or there was an error" };
            await InvokeAsync(StateHasChanged).ConfigureAwait(false);
        }

    }
}
